<!DOCTYPE html>
<html>
<head>
  <title>Live Location to GitHub</title>
</head>
<body>
  <h2>Send My Location to GitHub</h2>
  <button onclick="sendLocation()">Update location.json</button>

  <script>
    const token = "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"; // ⚠️ Only use in private/local testing
    const owner = "pothabattulavinod";
    const repo = "rto";
    const path = "location.json";
    const apiURL = `https://api.github.com/repos/${owner}/${repo}/contents/${path}`;

    async function sendLocation() {
      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }

      navigator.geolocation.getCurrentPosition(async pos => {
        const locationData = {
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          timestamp: new Date().toISOString()
        };

        const contentEncoded = btoa(JSON.stringify(locationData, null, 2));

        // Get existing file SHA
        let sha = null;
        try {
          const res = await fetch(apiURL, {
            headers: {
              Authorization: `Bearer ${token}`,
              Accept: "application/vnd.github+json"
            }
          });
          if (res.ok) {
            const data = await res.json();
            sha = data.sha;
          }
        } catch (e) {
          console.warn("location.json may not exist yet.");
        }

        // PUT request to overwrite location.json
        const updateRes = await fetch(apiURL, {
          method: "PUT",
          headers: {
            Authorization: `Bearer ${token}`,
            Accept: "application/vnd.github+json"
          },
          body: JSON.stringify({
            message: "Update live location",
            content: contentEncoded,
            sha: sha // Include SHA if file exists
          })
        });

        if (updateRes.ok) {
          alert("✅ location.json updated successfully!");
        } else {
          const err = await updateRes.json();
          console.error(err);
          alert("❌ Failed to update location.");
        }
      }, err => {
        alert("❌ Location access denied: " + err.message);
      });
    }
  </script>
</body>
</html>
